# ================================ XXE Injection ============================

# Prevent <!ENTITY something SYSTEM "something" pattern
# Ref: https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection#exploiting-xxe-to-retrieve-files
SecRule REQUEST_BODY "@rx <!entity\s+[^>]*?\s+system\s+" \
    "id:666666001,\
    phase:2,\
    deny,\
    t:none,t:lowercase,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:removeNulls,\
    msg:'XXE Attack detected by Polaris custom rules',\
    logdata:'Matched Data: XXE data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-xxe',\
    tag:'polaris-custom-rules'"


# Prevent XInclude attacks
# Ref: https://portswigger.net/web-security/xxe
SecRule REQUEST_BODY "@rx xmlns:\w+\s*=\s*[\"']http://www.w3.org/\w+/xinclude" \
    "id:666666002,\
    chain,\
    phase:2,\
    deny,\
    t:none,t:lowercase,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:removeNulls,\
    msg:'XInclude Attack detected by Polaris custom rules',\
    logdata:'Matched Data: XXE data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-xxe',\
    tag:'polaris-custom-rules'"

    SecRule REQUEST_BODY "@rx <\w+:include\s+[^>]*?href\s*=" \
        "t:none,t:lowercase,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:removeNulls"


# ================================ NoSQL Injection ============================

# Prevent uri?param[$something]=something pattern
# This rule is more strict than rule which id 942290
# Ref: https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection
SecRule REQUEST_URI "@rx [?&]\s*\w+\s*\[\$\w+]\s*=" \
    "id:666666003,\
    phase:2,\
    deny,\
    t:none,t:urlDecodeUni,t:lowercase,t:normalizePath,\
    msg:'NoSQL Injection Attack detected by Polaris custom rules',\
    logdata:'Matched Data: NoSQL injection data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-nosqli',\
    tag:'polaris-custom-rules'"

# Prevent {"username": {"$eq": "admin"}, "password": {"$regex": "^m" }} pattern
# Ref: https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection
SecRule REQUEST_BODY "@rx {\s*[\"']\$\w+[\"']\s*:" \
    "id:666666004,\
    phase:2,\
    deny,\
    t:none,t:urlDecodeUni,t:lowercase,t:normalizePath,\
    msg:'NoSQL Injection Attack detected by Polaris custom rules',\
    logdata:'Matched Data: NoSQL injection data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-nosqli',\
    tag:'polaris-custom-rules'"

# Prevent MongoDB injection in $where expression
# Prevent pattern ' || 'a'=='a
# Ref: https://nullsweep.com/a-nosql-injection-primer-with-mongo/
SecRule ARGS "@rx [\"']?\s*\\|\\|\s*('[^']*?'|\"[^\"]*?\")\s*==" \
    "id:666666005,\
    phase:2,\
    deny,\
    t:none,t:urlDecodeUni,t:lowercase,t:normalizePath,\
    msg:'NoSQL Injection Attack detected by Polaris custom rules',\
    logdata:'Matched Data: NoSQL injection data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-nosqli',\
    tag:'polaris-custom-rules'"

# ================================ Server Side Template Injection ============================

# Multiple types of server side template injection
# Ref: https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection
SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|ARGS_NAMES|ARGS|XML:/* "@rx (<%=.*?%>|#{.*?}|\${.*?})|\${{.*?}}|{{.*?}}" \
    "id:666666006,\
    phase:2,\
    deny,\
    t:none,t:urlDecodeUni,t:lowercase,t:normalizePath,\
    msg:'Server Side Template Injection Attack detected by Polaris custom rules',\
    logdata:'Matched Data: Template injection data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-template-injection',\
    tag:'polaris-custom-rules'"

# ================================ Insecure Object Deserialization ============================

# Detect pickle serialization
# Prevent using pickle os.system in base64 payload
SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|ARGS_NAMES|ARGS|XML:/* "@rx Y3Bvc2l4CnN5c3Rl" \
    "id:666666007,\
    phase:2,\
    deny,\
    t:none,t:urlDecodeUni,t:normalizePath,\
    msg:'Pickle Serialization Injection Attack detected by Polaris custom rules',\
    logdata:'Matched Data: Object injection data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-php',\
    tag:'platform-multi',\
    tag:'attack-deserialization',\
    tag:'polaris-custom-rules'"


# Detect pickle serialization
# Prevent using pickle subprocess.popen in base64 payload
SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|ARGS_NAMES|ARGS|XML:/* "@rx Y3N1YnByb2Nlc3MKUG9wZW4K" \
    "id:666666008,\
    phase:2,\
    deny,\
    t:none,t:urlDecodeUni,t:normalizePath,\
    msg:'Pickle Serialization Injection Attack detected by Polaris custom rules',\
    logdata:'Matched Data: Object injection data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-php',\
    tag:'platform-multi',\
    tag:'attack-deserialization',\
    tag:'polaris-custom-rules'"


# Detect PHP object serialization in request body
# Ref: https://hackerone.com/reports/562335
SecRule REQUEST_BODY "@rx [oOcC]:\d+:\".+?\":\d+:{.*}" \
    "id:666666009,\
    phase:2,\
    deny,\
    capture,\
    t:none,\
    msg:'PHP Injection Attack: Serialized Object Injection detected by Polaris custom rules',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-php',\
    tag:'platform-multi',\
    tag:'attack-deserialization',\
    tag:'polaris-custom-rules'"


# ================================ Ghostscript Upload ============================
# TODO

# ================================ Command Injection ============================

# This is a stricter version of rule 932100
# Prevent pattern like ; /b?n/ca? /e?c/pas?d
SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|ARGS_NAMES|ARGS|XML:/*|REQUEST_BODY "@rx (?:;|\{|\||\|\||&|&&|\n|\r|\$\(|\$\(\(|`|\${|<\(|>\(|\(\s*\))\s*(?:{|\s*\(\s*|\w+=(?:[^\s]*|\$.*|\$.*|<.*|>.*|\'.*\'|\".*\")\s+|!\s*|\$)*\s*(?:'|\")*(?:[\?\*\[\]\(\)\-\|+\w'\"\./\\\\]+/)?[\\\\'\"]*(?:[l\\?][\\\\'\"]*(?:[w\\?][\\\\'\"]*[p\\?][\\\\'\"]*-[\\\\'\"]*(?:[d\\?][\\\\'\"]*(?:[o\\?][\\\\'\"]*[w\\?][\\\\'\"]*[n\\?][\\\\'\"]*[l\\?][\\\\'\"]*[o\\?][\\\\'\"]*[a\\?][\\\\'\"]*[d\\?]|[u\\?][\\\\'\"]*[m\\?][\\\\'\"]*[p\\?])|[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[q\\?][\\\\'\"]*[u\\?][\\\\'\"]*[e\\?][\\\\'\"]*[s\\?][\\\\'\"]*[t\\?]|[m\\?][\\\\'\"]*[i\\?][\\\\'\"]*[r\\?][\\\\'\"]*[r\\?][\\\\'\"]*[o\\?][\\\\'\"]*[r\\?])|[s\\?](?:[\\\\'\"]*(?:[b\\?][\\\\'\"]*_[\\\\'\"]*[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[l\\?][\\\\'\"]*[e\\?][\\\\'\"]*[a\\?][\\\\'\"]*[s\\?][\\\\'\"]*[e\\?]|[c\\?][\\\\'\"]*[p\\?][\\\\'\"]*[u\\?]|[m\\?][\\\\'\"]*[o\\?][\\\\'\"]*[d\\?]|[p\\?][\\\\'\"]*[c\\?][\\\\'\"]*[i\\?]|[u\\?][\\\\'\"]*[s\\?][\\\\'\"]*[b\\?]|[h\\?][\\\\'\"]*[w\\?]|[o\\?][\\\\'\"]*[f\\?]|-[\\\\'\"]*[F\\?]))?|[z\\?][\\\\'\"]*(?:(?:(?:[e\\?]|[f\\?])[\\\\'\"]*)?[g\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[p\\?]|[c\\?][\\\\'\"]*(?:[a\\?][\\\\'\"]*[t\\?]|[m\\?][\\\\'\"]*[p\\?])|[m\\?][\\\\'\"]*(?:[o\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?]|[a\\?])|[d\\?][\\\\'\"]*[i\\?][\\\\'\"]*[f\\?][\\\\'\"]*[f\\?]|[l\\?][\\\\'\"]*[e\\?][\\\\'\"]*[s\\?][\\\\'\"]*[s\\?])|[e\\?][\\\\'\"]*[s\\?][\\\\'\"]*[s\\?][\\\\'\"]*(?:(?:[f\\?][\\\\'\"]*[i\\?][\\\\'\"]*[l\\?]|[p\\?][\\\\'\"]*[i\\?][\\\\'\"]*[p\\?])[\\\\'\"]*[e\\?]|[e\\?][\\\\'\"]*[c\\?][\\\\'\"]*[h\\?][\\\\'\"]*[o\\?]|(?:\s|<|>).*)|[a\\?][\\\\'\"]*[s\\?][\\\\'\"]*[t\\?][\\\\'\"]*(?:[l\\?][\\\\'\"]*[o\\?][\\\\'\"]*[g\\?](?:[\\\\'\"]*[i\\?][\\\\'\"]*[n\\?])?|[c\\?][\\\\'\"]*[o\\?][\\\\'\"]*[m\\?][\\\\'\"]*[m\\?]|(?:\s|<|>).*)|[o\\?][\\\\'\"]*(?:[c\\?][\\\\'\"]*[a\\?][\\\\'\"]*(?:[t\\?][\\\\'\"]*[e\\?]|[l\\?])[\\\\'\"]*(?:\s|<|>).*|[g\\?][\\\\'\"]*[n\\?][\\\\'\"]*[a\\?][\\\\'\"]*[m\\?][\\\\'\"]*[e\\?])|[d\\?][\\\\'\"]*(?:[c\\?][\\\\'\"]*[o\\?][\\\\'\"]*[n\\?][\\\\'\"]*[f\\?][\\\\'\"]*[i\\?][\\\\'\"]*[g\\?]|[d\\?][\\\\'\"]*(?:\s|<|>).*)|[f\\?][\\\\'\"]*[t\\?][\\\\'\"]*[p\\?](?:[\\\\'\"]*[g\\?][\\\\'\"]*[e\\?][\\\\'\"]*[t\\?])?|(?:[y\\?][\\\\'\"]*[n\\?][\\\\'\"]*[x\\?]|[n\\?]|[p\\?])[\\\\'\"]*(?:\s|<|>).*)|[b\\?][\\\\'\"]*(?:[z\\?][\\\\'\"]*(?:(?:(?:[e\\?]|[f\\?])[\\\\'\"]*)?[g\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[p\\?]|[d\\?][\\\\'\"]*[i\\?][\\\\'\"]*[f\\?][\\\\'\"]*[f\\?]|[l\\?][\\\\'\"]*[e\\?][\\\\'\"]*[s\\?][\\\\'\"]*[s\\?]|[m\\?][\\\\'\"]*[o\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?]|[c\\?][\\\\'\"]*[a\\?][\\\\'\"]*[t\\?]|[i\\?][\\\\'\"]*[p\\?][\\\\'\"]*[2\\?])|[s\\?][\\\\'\"]*[d\\?][\\\\'\"]*(?:[c\\?][\\\\'\"]*[a\\?][\\\\'\"]*[t\\?]|[i\\?][\\\\'\"]*[f\\?][\\\\'\"]*[f\\?]|[t\\?][\\\\'\"]*[a\\?][\\\\'\"]*[r\\?])|[a\\?][\\\\'\"]*(?:[t\\?][\\\\'\"]*[c\\?][\\\\'\"]*[h\\?][\\\\'\"]*(?:\s|<|>).*|[s\\?][\\\\'\"]*[h\\?])|[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[a\\?][\\\\'\"]*[k\\?][\\\\'\"]*[s\\?][\\\\'\"]*[w\\?]|[u\\?][\\\\'\"]*[i\\?][\\\\'\"]*[l\\?][\\\\'\"]*[t\\?][\\\\'\"]*[i\\?][\\\\'\"]*[n\\?])|[c\\?][\\\\'\"]*(?:[h\\?][\\\\'\"]*(?:[f\\?][\\\\'\"]*[l\\?][\\\\'\"]*[a\\?][\\\\'\"]*[g\\?][\\\\'\"]*[s\\?]|[d\\?][\\\\'\"]*[i\\?][\\\\'\"]*[r\\?][\\\\'\"]*(?:\s|<|>).*|[a\\?][\\\\'\"]*[t\\?][\\\\'\"]*[t\\?][\\\\'\"]*[r\\?]|[m\\?][\\\\'\"]*[o\\?][\\\\'\"]*[d\\?])|[o\\?][\\\\'\"]*(?:[m\\?][\\\\'\"]*(?:[p\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[s\\?][\\\\'\"]*[s\\?]|[m\\?][\\\\'\"]*[a\\?][\\\\'\"]*[n\\?][\\\\'\"]*[d\\?])[\\\\'\"]*(?:\s|<|>).*|[p\\?][\\\\'\"]*[r\\?][\\\\'\"]*[o\\?][\\\\'\"]*[c\\?])|[r\\?][\\\\'\"]*[o\\?][\\\\'\"]*[n\\?][\\\\'\"]*[t\\?][\\\\'\"]*[a\\?][\\\\'\"]*[b\\?]|(?:[a\\?][\\\\'\"]*[t\\?]|[c\\?]|[p\\?])[\\\\'\"]*(?:\s|<|>).*|[u\\?][\\\\'\"]*[r\\?][\\\\'\"]*[l\\?]|[s\\?][\\\\'\"]*[h\\?])|[f\\?][\\\\'\"]*(?:[i\\?](?:[\\\\'\"]*(?:[l\\?][\\\\'\"]*[e\\?][\\\\'\"]*(?:[t\\?][\\\\'\"]*[e\\?][\\\\'\"]*[s\\?][\\\\'\"]*[t\\?]|(?:\s|<|>).*)|[n\\?][\\\\'\"]*[d\\?][\\\\'\"]*(?:\s|<|>).*))?|[t\\?][\\\\'\"]*[p\\?][\\\\'\"]*(?:[s\\?][\\\\'\"]*[t\\?][\\\\'\"]*[a\\?][\\\\'\"]*[t\\?][\\\\'\"]*[s\\?]|[w\\?][\\\\'\"]*[h\\?][\\\\'\"]*[o\\?]|(?:\s|<|>).*)|[u\\?][\\\\'\"]*[n\\?][\\\\'\"]*[c\\?][\\\\'\"]*[t\\?][\\\\'\"]*[i\\?][\\\\'\"]*[o\\?][\\\\'\"]*[n\\?]|(?:[e\\?][\\\\'\"]*[t\\?][\\\\'\"]*[c\\?][\\\\'\"]*[h\\?]|[c\\?])[\\\\'\"]*(?:\s|<|>).*|[o\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[a\\?][\\\\'\"]*[c\\?][\\\\'\"]*[h\\?]|[g\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[p\\?])|[e\\?][\\\\'\"]*(?:[n\\?][\\\\'\"]*(?:[v\\?](?:[\\\\'\"]*-[\\\\'\"]*[u\\?][\\\\'\"]*[p\\?][\\\\'\"]*[d\\?][\\\\'\"]*[a\\?][\\\\'\"]*[t\\?][\\\\'\"]*[e\\?])?|[d\\?][\\\\'\"]*(?:[i\\?][\\\\'\"]*[f\\?]|[s\\?][\\\\'\"]*[w\\?]))|[x\\?][\\\\'\"]*(?:[p\\?][\\\\'\"]*(?:[a\\?][\\\\'\"]*[n\\?][\\\\'\"]*[d\\?]|[o\\?][\\\\'\"]*[r\\?][\\\\'\"]*[t\\?]|[r\\?])|[e\\?][\\\\'\"]*[c\\?][\\\\'\"]*(?:\s|<|>).*)|[c\\?][\\\\'\"]*[h\\?][\\\\'\"]*[o\\?][\\\\'\"]*(?:\s|<|>).*|[g\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[p\\?]|[s\\?][\\\\'\"]*[a\\?][\\\\'\"]*[c\\?]|[v\\?][\\\\'\"]*[a\\?][\\\\'\"]*[l\\?])|[h\\?][\\\\'\"]*(?:[t\\?][\\\\'\"]*(?:[d\\?][\\\\'\"]*[i\\?][\\\\'\"]*[g\\?][\\\\'\"]*[e\\?][\\\\'\"]*[s\\?][\\\\'\"]*[t\\?]|[p\\?][\\\\'\"]*[a\\?][\\\\'\"]*[s\\?][\\\\'\"]*[s\\?][\\\\'\"]*[w\\?][\\\\'\"]*[d\\?])|[o\\?][\\\\'\"]*[s\\?][\\\\'\"]*[t\\?][\\\\'\"]*(?:[n\\?][\\\\'\"]*[a\\?][\\\\'\"]*[m\\?][\\\\'\"]*[e\\?]|[i\\?][\\\\'\"]*[d\\?])|(?:[e\\?][\\\\'\"]*[a\\?][\\\\'\"]*[d\\?]|[u\\?][\\\\'\"]*[p\\?])[\\\\'\"]*(?:\s|<|>).*|[i\\?][\\\\'\"]*[s\\?][\\\\'\"]*[t\\?][\\\\'\"]*[o\\?][\\\\'\"]*[r\\?][\\\\'\"]*[y\\?])|[i\\?][\\\\'\"]*(?:[p\\?][\\\\'\"]*(?:(?:[6\\?][\\\\'\"]*)?[t\\?][\\\\'\"]*[a\\?][\\\\'\"]*[b\\?][\\\\'\"]*[l\\?][\\\\'\"]*[e\\?][\\\\'\"]*[s\\?]|[c\\?][\\\\'\"]*[o\\?][\\\\'\"]*[n\\?][\\\\'\"]*[f\\?][\\\\'\"]*[i\\?][\\\\'\"]*[g\\?])|[r\\?][\\\\'\"]*[b\\?](?:[\\\\'\"]*(?:[2\\?][\\\\'\"]*(?:[0\\?]|[1\\?]|[2\\?])|[1\\?](?:[\\\\'\"]*(?:[8\\?]|[9\\?]))?))?|[f\\?][\\\\'\"]*[c\\?][\\\\'\"]*[o\\?][\\\\'\"]*[n\\?][\\\\'\"]*[f\\?][\\\\'\"]*[i\\?][\\\\'\"]*[g\\?]|[d\\?][\\\\'\"]*(?:\s|<|>).*)|[g\\?][\\\\'\"]*(?:(?:[e\\?][\\\\'\"]*[t\\?][\\\\'\"]*[f\\?][\\\\'\"]*[a\\?][\\\\'\"]*[c\\?][\\\\'\"]*[l\\?]|[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[p\\?]|[c\\?][\\\\'\"]*[c\\?]|[i\\?][\\\\'\"]*[t\\?])[\\\\'\"]*(?:\s|<|>).*|[z\\?][\\\\'\"]*(?:[c\\?][\\\\'\"]*[a\\?][\\\\'\"]*[t\\?]|[i\\?][\\\\'\"]*[p\\?])|[u\\?][\\\\'\"]*[n\\?][\\\\'\"]*[z\\?][\\\\'\"]*[i\\?][\\\\'\"]*[p\\?]|[d\\?][\\\\'\"]*[b\\?])|[d\\?][\\\\'\"]*(?:[h\\?][\\\\'\"]*[c\\?][\\\\'\"]*[l\\?][\\\\'\"]*[i\\?][\\\\'\"]*[e\\?][\\\\'\"]*[n\\?][\\\\'\"]*[t\\?]|(?:[m\\?][\\\\'\"]*[e\\?][\\\\'\"]*[s\\?]|[p\\?][\\\\'\"]*[k\\?])[\\\\'\"]*[g\\?]|(?:[i\\?][\\\\'\"]*[f\\?][\\\\'\"]*[f\\?]|[u\\?])[\\\\'\"]*(?:\s|<|>).*|[o\\?][\\\\'\"]*(?:[a\\?][\\\\'\"]*[s\\?]|[n\\?][\\\\'\"]*[e\\?])|[a\\?][\\\\'\"]*[s\\?][\\\\'\"]*[h\\?])|[a\\?][\\\\'\"]*(?:(?:[l\\?][\\\\'\"]*[i\\?][\\\\'\"]*[a\\?][\\\\'\"]*[s\\?]|[w\\?][\\\\'\"]*[k\\?])[\\\\'\"]*(?:\s|<|>).*|[d\\?][\\\\'\"]*[d\\?][\\\\'\"]*[u\\?][\\\\'\"]*[s\\?][\\\\'\"]*[e\\?][\\\\'\"]*[r\\?]|[p\\?][\\\\'\"]*[t\\?][\\\\'\"]*-[\\\\'\"]*[g\\?][\\\\'\"]*[e\\?][\\\\'\"]*[t\\?]|[r\\?][\\\\'\"]*(?:[c\\?][\\\\'\"]*[h\\?][\\\\'\"]*(?:\s|<|>).*|[p\\?]))|[m\\?][\\\\'\"]*(?:(?:[k\\?][\\\\'\"]*[d\\?][\\\\'\"]*[i\\?][\\\\'\"]*[r\\?]|[o\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?])[\\\\'\"]*(?:\s|<|>).*|[a\\?][\\\\'\"]*[i\\?][\\\\'\"]*[l\\?][\\\\'\"]*(?:[x\\?][\\\\'\"]*(?:\s|<|>).*|[q\\?])|[l\\?][\\\\'\"]*[o\\?][\\\\'\"]*[c\\?][\\\\'\"]*[a\\?][\\\\'\"]*[t\\?][\\\\'\"]*[e\\?])|[j\\?][\\\\'\"]*(?:(?:[a\\?][\\\\'\"]*[v\\?][\\\\'\"]*[a\\?]|[o\\?][\\\\'\"]*[b\\?][\\\\'\"]*[s\\?])[\\\\'\"]*(?:\s|<|>).*|[e\\?][\\\\'\"]*[x\\?][\\\\'\"]*[e\\?][\\\\'\"]*[c\\?])|[k\\?][\\\\'\"]*[i\\?][\\\\'\"]*[l\\?][\\\\'\"]*[l\\?][\\\\'\"]*(?:[a\\?][\\\\'\"]*[l\\?][\\\\'\"]*[l\\?]|(?:\s|<|>).*)|(?:[G\\?][\\\\'\"]*[E\\?][\\\\'\"]*[T\\?][\\\\'\"]*(?:\s|<|>)|\.\s).*|[7\\?][\\\\'\"]*[z\\?](?:[\\\\'\"]*(?:[a\\?]|[r\\?]))?)\b" \
    "id:666666010,\
    phase:2,\
    deny,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:jsDecode,t:cssDecode,t:removeNulls,\
    msg:'Remote Command Execution: Unix Command Injection detected by Polaris custom rules',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-rce',\
    tag:'polaris-custom-rules'"

# This is a stricter version of rule 932105
# Prevent pattern like ; /b?n/ca? /e?c/pas?d
SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|ARGS_NAMES|ARGS|XML:/*|REQUEST_BODY "@rx (?:;|\{|\||\|\||&|&&|\n|\r|\$\(|\$\(\(|`|\${|<\(|>\(|\(\s*\))\s*(?:{|\s*\(\s*|\w+=(?:[^\s]*|\$.*|\$.*|<.*|>.*|\'.*\'|\".*\")\s+|!\s*|\$)*\s*(?:'|\")*(?:[\?\*\[\]\(\)\-\|+\w'\"\./\\\\]+/)?[\\\\'\"]*(?:[s\\?][\\\\'\"]*(?:[e\\?][\\\\'\"]*(?:[t\\?][\\\\'\"]*(?:(?:[f\\?][\\\\'\"]*[a\\?][\\\\'\"]*[c\\?][\\\\'\"]*[l\\?][\\\\'\"]*)?(?:\s|<|>).*|[e\\?][\\\\'\"]*[n\\?][\\\\'\"]*[v\\?]|[s\\?][\\\\'\"]*[i\\?][\\\\'\"]*[d\\?])|[n\\?][\\\\'\"]*[d\\?][\\\\'\"]*[m\\?][\\\\'\"]*[a\\?][\\\\'\"]*[i\\?][\\\\'\"]*[l\\?]|[d\\?][\\\\'\"]*(?:\s|<|>).*)|[h\\?][\\\\'\"]*(?:\.[\\\\'\"]*[d\\?][\\\\'\"]*[i\\?][\\\\'\"]*[s\\?][\\\\'\"]*[t\\?][\\\\'\"]*[r\\?][\\\\'\"]*[i\\?][\\\\'\"]*[b\\?]|[u\\?][\\\\'\"]*[t\\?][\\\\'\"]*[d\\?][\\\\'\"]*[o\\?][\\\\'\"]*[w\\?][\\\\'\"]*[n\\?]|(?:\s|<|>).*)|[o\\?][\\\\'\"]*(?:(?:[u\\?][\\\\'\"]*[r\\?][\\\\'\"]*[c\\?][\\\\'\"]*[e\\?]|[r\\?][\\\\'\"]*[t\\?])[\\\\'\"]*(?:\s|<|>).*|[c\\?][\\\\'\"]*[a\\?][\\\\'\"]*[t\\?])|[c\\?][\\\\'\"]*(?:[h\\?][\\\\'\"]*[e\\?][\\\\'\"]*[d\\?]|[p\\?][\\\\'\"]*(?:\s|<|>).*)|[t\\?][\\\\'\"]*[r\\?][\\\\'\"]*[i\\?][\\\\'\"]*[n\\?][\\\\'\"]*[g\\?][\\\\'\"]*[s\\?]|(?:[l\\?][\\\\'\"]*[e\\?][\\\\'\"]*[e\\?]|[f\\?][\\\\'\"]*[t\\?])[\\\\'\"]*[p\\?]|[y\\?][\\\\'\"]*[s\\?][\\\\'\"]*[c\\?][\\\\'\"]*[t\\?][\\\\'\"]*[l\\?]|[u\\?][\\\\'\"]*(?:[d\\?][\\\\'\"]*[o\\?]|(?:\s|<|>).*)|[d\\?][\\\\'\"]*[i\\?][\\\\'\"]*[f\\?][\\\\'\"]*[f\\?]|[s\\?][\\\\'\"]*[h\\?]|[v\\?][\\\\'\"]*[n\\?])|[p\\?][\\\\'\"]*(?:[k\\?][\\\\'\"]*(?:[g\\?](?:(?:[\\\\'\"]*_)?[\\\\'\"]*[i\\?][\\\\'\"]*[n\\?][\\\\'\"]*[f\\?][\\\\'\"]*[o\\?])?|[e\\?][\\\\'\"]*[x\\?][\\\\'\"]*[e\\?][\\\\'\"]*[c\\?]|[i\\?][\\\\'\"]*[l\\?][\\\\'\"]*[l\\?])|[t\\?][\\\\'\"]*[a\\?][\\\\'\"]*[r\\?](?:[\\\\'\"]*(?:[d\\?][\\\\'\"]*[i\\?][\\\\'\"]*[f\\?][\\\\'\"]*[f\\?]|[g\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[p\\?]))?|[a\\?][\\\\'\"]*(?:[t\\?][\\\\'\"]*[c\\?][\\\\'\"]*[h\\?][\\\\'\"]*(?:\s|<|>).*|[s\\?][\\\\'\"]*[s\\?][\\\\'\"]*[w\\?][\\\\'\"]*[d\\?])|[r\\?][\\\\'\"]*[i\\?][\\\\'\"]*[n\\?][\\\\'\"]*[t\\?][\\\\'\"]*(?:[e\\?][\\\\'\"]*[n\\?][\\\\'\"]*[v\\?]|[f\\?][\\\\'\"]*(?:\s|<|>).*)|[y\\?][\\\\'\"]*[t\\?][\\\\'\"]*[h\\?][\\\\'\"]*[o\\?][\\\\'\"]*[n\\?](?:[\\\\'\"]*(?:[3\\?](?:[\\\\'\"]*[m\\?])?|[2\\?]))?|[e\\?][\\\\'\"]*[r\\?][\\\\'\"]*(?:[l\\?](?:[\\\\'\"]*(?:[s\\?][\\\\'\"]*[h\\?]|[5\\?]))?|[m\\?][\\\\'\"]*[s\\?])|(?:[g\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?]|[f\\?][\\\\'\"]*[t\\?])[\\\\'\"]*[p\\?]|(?:[u\\?][\\\\'\"]*[s\\?][\\\\'\"]*[h\\?]|[o\\?][\\\\'\"]*[p\\?])[\\\\'\"]*[d\\?]|[h\\?][\\\\'\"]*[p\\?](?:[\\\\'\"]*(?:[5\\?]|[7\\?]))?|[i\\?][\\\\'\"]*[n\\?][\\\\'\"]*[g\\?]|[s\\?][\\\\'\"]*(?:\s|<|>).*)|[n\\?][\\\\'\"]*(?:[c\\?][\\\\'\"]*(?:\.[\\\\'\"]*(?:[t\\?][\\\\'\"]*[r\\?][\\\\'\"]*[a\\?][\\\\'\"]*[d\\?][\\\\'\"]*[i\\?][\\\\'\"]*[t\\?][\\\\'\"]*[i\\?][\\\\'\"]*[o\\?][\\\\'\"]*[n\\?][\\\\'\"]*[a\\?][\\\\'\"]*[l\\?]|[o\\?][\\\\'\"]*[p\\?][\\\\'\"]*[e\\?][\\\\'\"]*[n\\?][\\\\'\"]*[b\\?][\\\\'\"]*[s\\?][\\\\'\"]*[d\\?])|[a\\?][\\\\'\"]*[t\\?]|(?:\s|<|>).*)|[e\\?][\\\\'\"]*[t\\?][\\\\'\"]*(?:[k\\?][\\\\'\"]*[i\\?][\\\\'\"]*[t\\?][\\\\'\"]*-[\\\\'\"]*[f\\?][\\\\'\"]*[t\\?][\\\\'\"]*[p\\?]|(?:[s\\?][\\\\'\"]*[t\\?]|[c\\?])[\\\\'\"]*[a\\?][\\\\'\"]*[t\\?]|(?:\s|<|>).*)|[s\\?][\\\\'\"]*(?:[l\\?][\\\\'\"]*[o\\?][\\\\'\"]*[o\\?][\\\\'\"]*[k\\?][\\\\'\"]*[u\\?][\\\\'\"]*[p\\?]|[t\\?][\\\\'\"]*[a\\?][\\\\'\"]*[t\\?])|(?:[a\\?][\\\\'\"]*[n\\?][\\\\'\"]*[o\\?]|[i\\?][\\\\'\"]*[c\\?][\\\\'\"]*[e\\?])[\\\\'\"]*(?:\s|<|>).*|(?:[o\\?][\\\\'\"]*[h\\?][\\\\'\"]*[u\\?]|[m\\?][\\\\'\"]*[a\\?])[\\\\'\"]*[p\\?]|[p\\?][\\\\'\"]*[i\\?][\\\\'\"]*[n\\?][\\\\'\"]*[g\\?])|[r\\?][\\\\'\"]*(?:[e\\?][\\\\'\"]*(?:(?:[p\\?][\\\\'\"]*(?:[l\\?][\\\\'\"]*[a\\?][\\\\'\"]*[c\\?][\\\\'\"]*[e\\?]|[e\\?][\\\\'\"]*[a\\?][\\\\'\"]*[t\\?])|[n\\?][\\\\'\"]*[a\\?][\\\\'\"]*[m\\?][\\\\'\"]*[e\\?])[\\\\'\"]*(?:\s|<|>).*|[a\\?][\\\\'\"]*[l\\?][\\\\'\"]*[p\\?][\\\\'\"]*[a\\?][\\\\'\"]*[t\\?][\\\\'\"]*[h\\?])|[m\\?][\\\\'\"]*(?:(?:[d\\?][\\\\'\"]*[i\\?][\\\\'\"]*[r\\?][\\\\'\"]*)?(?:\s|<|>).*|[u\\?][\\\\'\"]*[s\\?][\\\\'\"]*[e\\?][\\\\'\"]*[r\\?])|[u\\?][\\\\'\"]*[b\\?][\\\\'\"]*[y\\?](?:[\\\\'\"]*(?:[2\\?][\\\\'\"]*(?:[0\\?]|[1\\?]|[2\\?])|[1\\?](?:[\\\\'\"]*(?:[8\\?]|[9\\?]))?))?|(?:[a\\?][\\\\'\"]*[r\\?]|[c\\?][\\\\'\"]*[p\\?]|[p\\?][\\\\'\"]*[m\\?])[\\\\'\"]*(?:\s|<|>).*|[n\\?][\\\\'\"]*[a\\?][\\\\'\"]*[n\\?][\\\\'\"]*[o\\?]|[o\\?][\\\\'\"]*[u\\?][\\\\'\"]*[t\\?][\\\\'\"]*[e\\?]|[s\\?][\\\\'\"]*[y\\?][\\\\'\"]*[n\\?][\\\\'\"]*[c\\?])|[t\\?][\\\\'\"]*(?:[c\\?][\\\\'\"]*(?:[p\\?][\\\\'\"]*(?:[t\\?][\\\\'\"]*[r\\?][\\\\'\"]*[a\\?][\\\\'\"]*[c\\?][\\\\'\"]*[e\\?][\\\\'\"]*[r\\?][\\\\'\"]*[o\\?][\\\\'\"]*[u\\?][\\\\'\"]*[t\\?][\\\\'\"]*[e\\?]|[i\\?][\\\\'\"]*[n\\?][\\\\'\"]*[g\\?])|[s\\?][\\\\'\"]*[h\\?])|[r\\?][\\\\'\"]*[a\\?][\\\\'\"]*[c\\?][\\\\'\"]*[e\\?][\\\\'\"]*[r\\?][\\\\'\"]*[o\\?][\\\\'\"]*[u\\?][\\\\'\"]*[t\\?][\\\\'\"]*[e\\?](?:[\\\\'\"]*[6\\?])?|[e\\?][\\\\'\"]*(?:[l\\?][\\\\'\"]*[n\\?][\\\\'\"]*[e\\?][\\\\'\"]*[t\\?]|[e\\?][\\\\'\"]*(?:\s|<|>).*)|[i\\?][\\\\'\"]*[m\\?][\\\\'\"]*[e\\?][\\\\'\"]*(?:[o\\?][\\\\'\"]*[u\\?][\\\\'\"]*[t\\?]|(?:\s|<|>).*)|[a\\?][\\\\'\"]*(?:[i\\?][\\\\'\"]*[l\\?](?:[\\\\'\"]*[f\\?])?|[r\\?][\\\\'\"]*(?:\s|<|>).*)|[o\\?][\\\\'\"]*(?:[u\\?][\\\\'\"]*[c\\?][\\\\'\"]*[h\\?][\\\\'\"]*(?:\s|<|>).*|[p\\?]))|[u\\?][\\\\'\"]*(?:[n\\?][\\\\'\"]*(?:[l\\?][\\\\'\"]*(?:[i\\?][\\\\'\"]*[n\\?][\\\\'\"]*[k\\?][\\\\'\"]*(?:\s|<|>).*|[z\\?][\\\\'\"]*[m\\?][\\\\'\"]*[a\\?])|[c\\?][\\\\'\"]*[o\\?][\\\\'\"]*[m\\?][\\\\'\"]*[p\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[s\\?][\\\\'\"]*[s\\?]|[a\\?][\\\\'\"]*[m\\?][\\\\'\"]*[e\\?]|[r\\?][\\\\'\"]*[a\\?][\\\\'\"]*[r\\?]|[s\\?][\\\\'\"]*[e\\?][\\\\'\"]*[t\\?]|[z\\?][\\\\'\"]*[i\\?][\\\\'\"]*[p\\?]|[x\\?][\\\\'\"]*[z\\?])|[s\\?][\\\\'\"]*[e\\?][\\\\'\"]*[r\\?][\\\\'\"]*(?:(?:[a\\?][\\\\'\"]*[d\\?]|[m\\?][\\\\'\"]*[o\\?])[\\\\'\"]*[d\\?]|[d\\?][\\\\'\"]*[e\\?][\\\\'\"]*[l\\?])|[l\\?][\\\\'\"]*[i\\?][\\\\'\"]*[m\\?][\\\\'\"]*[i\\?][\\\\'\"]*[t\\?][\\\\'\"]*(?:\s|<|>).*)|[m\\?][\\\\'\"]*(?:[y\\?][\\\\'\"]*[s\\?][\\\\'\"]*[q\\?][\\\\'\"]*[l\\?](?:[\\\\'\"]*(?:[d\\?][\\\\'\"]*[u\\?][\\\\'\"]*[m\\?][\\\\'\"]*[p\\?](?:[\\\\'\"]*[s\\?][\\\\'\"]*[l\\?][\\\\'\"]*[o\\?][\\\\'\"]*[w\\?])?|[h\\?][\\\\'\"]*[o\\?][\\\\'\"]*[t\\?][\\\\'\"]*[c\\?][\\\\'\"]*[o\\?][\\\\'\"]*[p\\?][\\\\'\"]*[y\\?]|[a\\?][\\\\'\"]*[d\\?][\\\\'\"]*[m\\?][\\\\'\"]*[i\\?][\\\\'\"]*[n\\?]|[s\\?][\\\\'\"]*[h\\?][\\\\'\"]*[o\\?][\\\\'\"]*[w\\?]))?|(?:(?:[o\\?][\\\\'\"]*[u\\?][\\\\'\"]*[n\\?]|[u\\?][\\\\'\"]*[t\\?])[\\\\'\"]*[t\\?]|[v\\?])[\\\\'\"]*(?:\s|<|>).*)|[x\\?][\\\\'\"]*(?:[z\\?][\\\\'\"]*(?:(?:(?:[e\\?]|[f\\?])[\\\\'\"]*)?[g\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[p\\?]|[d\\?][\\\\'\"]*(?:[i\\?][\\\\'\"]*[f\\?][\\\\'\"]*[f\\?]|[e\\?][\\\\'\"]*[c\\?])|[c\\?][\\\\'\"]*(?:[a\\?][\\\\'\"]*[t\\?]|[m\\?][\\\\'\"]*[p\\?])|[l\\?][\\\\'\"]*[e\\?][\\\\'\"]*[s\\?][\\\\'\"]*[s\\?]|[m\\?][\\\\'\"]*[o\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?]|(?:\s|<|>).*)|[a\\?][\\\\'\"]*[r\\?][\\\\'\"]*[g\\?][\\\\'\"]*[s\\?]|[t\\?][\\\\'\"]*[e\\?][\\\\'\"]*[r\\?][\\\\'\"]*[m\\?]|[x\\?][\\\\'\"]*[d\\?][\\\\'\"]*(?:\s|<|>).*)|[z\\?][\\\\'\"]*(?:(?:(?:[e\\?]|[f\\?])[\\\\'\"]*)?[g\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?][\\\\'\"]*[p\\?]|[c\\?][\\\\'\"]*(?:[a\\?][\\\\'\"]*[t\\?]|[m\\?][\\\\'\"]*[p\\?])|[d\\?][\\\\'\"]*[i\\?][\\\\'\"]*[f\\?][\\\\'\"]*[f\\?]|[l\\?][\\\\'\"]*[e\\?][\\\\'\"]*[s\\?][\\\\'\"]*[s\\?]|[m\\?][\\\\'\"]*[o\\?][\\\\'\"]*[r\\?][\\\\'\"]*[e\\?]|[i\\?][\\\\'\"]*[p\\?][\\\\'\"]*(?:\s|<|>).*|[r\\?][\\\\'\"]*[u\\?][\\\\'\"]*[n\\?]|[s\\?][\\\\'\"]*[h\\?])|[o\\?][\\\\'\"]*(?:[p\\?][\\\\'\"]*[e\\?][\\\\'\"]*[n\\?][\\\\'\"]*[s\\?][\\\\'\"]*[s\\?][\\\\'\"]*[l\\?]|[n\\?][\\\\'\"]*[i\\?][\\\\'\"]*[n\\?][\\\\'\"]*[t\\?][\\\\'\"]*[r\\?])|[w\\?][\\\\'\"]*(?:[h\\?][\\\\'\"]*[o\\?][\\\\'\"]*(?:[a\\?][\\\\'\"]*[m\\?][\\\\'\"]*[i\\?]|(?:\s|<|>).*)|[g\\?][\\\\'\"]*[e\\?][\\\\'\"]*[t\\?]|[3\\?][\\\\'\"]*[m\\?])|[v\\?][\\\\'\"]*[i\\?][\\\\'\"]*(?:[m\\?][\\\\'\"]*(?:\s|<|>).*|[g\\?][\\\\'\"]*[r\\?]|[p\\?][\\\\'\"]*[w\\?])|[y\\?][\\\\'\"]*[u\\?][\\\\'\"]*[m\\?])\b" \
    "id:666666011,\
    phase:2,\
    deny,\
    capture,\
    t:none,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:jsDecode,t:cssDecode,t:removeNulls,\
    msg:'Remote Command Execution: Unix Command Injection detected by Polaris custom rules',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-rce',\
    tag:'polaris-custom-rules'"

