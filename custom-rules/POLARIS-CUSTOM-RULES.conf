# ================================ XXE rules ============================

# Prevent <!ENTITY something SYSTEM "something" pattern
# Ref: https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection#exploiting-xxe-to-retrieve-files
SecRule REQUEST_BODY "@rx <!entity\s+[^>]*?\s+system\s+" \
    "id:666666001,\
    phase:2,\
    deny,\
    t:none,t:lowercase,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:removeNulls,\
    msg:'XXE Attack detected by Polaris custom rules',\
    logdata:'Matched Data: XXE data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-xxe',\
    tag:'polaris-custom-rules'"


# Prevent XInclude attacks
# Ref: https://portswigger.net/web-security/xxe
SecRule REQUEST_BODY "@rx xmlns:\w+\s*=\s*[\"']http://www.w3.org/\w+/xinclude" \
    "id:666666002,\
    chain,\
    phase:2,\
    deny,\
    t:none,t:lowercase,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:removeNulls,\
    msg:'XInclude Attack detected by Polaris custom rules',\
    logdata:'Matched Data: XXE data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-xxe',\
    tag:'polaris-custom-rules'"

    SecRule REQUEST_BODY "@rx <\w+:include\s+[^>]*?href\s*=" \
        "t:none,t:lowercase,t:utf8toUnicode,t:urlDecodeUni,t:htmlEntityDecode,t:removeNulls"


# ================================ NoSQL injection rules ============================

# Prevent uri?param[$something]=something pattern
# This rule is more strict than rule which id 942290
# Ref: https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection
SecRule REQUEST_URI "@rx [?&]\s*\w+\s*\[\$\w+]\s*=" \
    "id:666666003,\
    phase:2,\
    deny,\
    t:none,t:urlDecodeUni,t:lowercase,t:normalizePath,\
    msg:'NoSQL Injection Attack detected by Polaris custom rules',\
    logdata:'Matched Data: NoSQL injection data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-nosqli',\
    tag:'polaris-custom-rules'"

# Prevent {"username": {"$eq": "admin"}, "password": {"$regex": "^m" }} pattern
# Ref: https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection
SecRule REQUEST_BODY "@rx {\s*[\"']\$\w+[\"']\s*:" \
    "id:666666004,\
    phase:2,\
    deny,\
    t:none,t:urlDecodeUni,t:lowercase,t:normalizePath,\
    msg:'NoSQL Injection Attack detected by Polaris custom rules',\
    logdata:'Matched Data: NoSQL injection data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-nosqli',\
    tag:'polaris-custom-rules'"

# Prevent MongoDB injection in $where expression
# Prevent pattern ' || 'a'=='a
# Ref: https://nullsweep.com/a-nosql-injection-primer-with-mongo/
SecRule ARGS "@rx [\"']?\s*\\|\\|\s*('[^']*?'|\"[^\"]*?\")\s*==" \
    "id:666666005,\
    phase:2,\
    deny,\
    t:none,t:urlDecodeUni,t:lowercase,t:normalizePath,\
    msg:'NoSQL Injection Attack detected by Polaris custom rules',\
    logdata:'Matched Data: NoSQL injection data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-nosqli',\
    tag:'polaris-custom-rules'"

# ================================ Templates Injections rules ============================

# Multiple types of server side template injection
# Ref: https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection
SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|ARGS_NAMES|ARGS|XML:/* "@rx (<%=.*?%>|#{.*?}|\${.*?})|\${{.*?}}|{{.*?}}" \
    "id:666666006,\
    phase:2,\
    deny,\
    t:none,t:urlDecodeUni,t:lowercase,t:normalizePath,\
    msg:'Server Side Template Injection Attack detected by Polaris custom rules',\
    logdata:'Matched Data: Template injection data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-multi',\
    tag:'platform-multi',\
    tag:'attack-template-injection',\
    tag:'polaris-custom-rules'"

# ================================ Insecure object deserialization rules ============================

# Detect pickle serialization
# Prevent using pickle os.system in base64 payload
SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|ARGS_NAMES|ARGS|XML:/* "@rx Y3Bvc2l4CnN5c3Rl" \
    "id:666666007,\
    phase:2,\
    deny,\
    t:none,t:urlDecodeUni,t:normalizePath,\
    msg:'Pickle Serialization Injection Attack detected by Polaris custom rules',\
    logdata:'Matched Data: Object injection data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-php',\
    tag:'platform-multi',\
    tag:'attack-deserialization',\
    tag:'polaris-custom-rules'"


# Detect pickle serialization
# Prevent using pickle subprocess.popen in base64 payload
SecRule REQUEST_COOKIES|!REQUEST_COOKIES:/__utm/|REQUEST_COOKIES_NAMES|ARGS_NAMES|ARGS|XML:/* "@rx Y3N1YnByb2Nlc3MKUG9wZW4K" \
    "id:666666008,\
    phase:2,\
    deny,\
    t:none,t:urlDecodeUni,t:normalizePath,\
    msg:'Pickle Serialization Injection Attack detected by Polaris custom rules',\
    logdata:'Matched Data: Object injection data found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-php',\
    tag:'platform-multi',\
    tag:'attack-deserialization',\
    tag:'polaris-custom-rules'"


# Detect PHP object serialization in request body
# Ref: https://hackerone.com/reports/562335
SecRule REQUEST_BODY "@rx [oOcC]:\d+:\".+?\":\d+:{.*}" \
    "id:666666009,\
    phase:2,\
    deny,\
    capture,\
    t:none,\
    msg:'PHP Injection Attack: Serialized Object Injection detected by Polaris custom rules',\
    logdata:'Matched Data: %{TX.0} found within %{MATCHED_VAR_NAME}: %{MATCHED_VAR}',\
    tag:'application-multi',\
    tag:'language-php',\
    tag:'platform-multi',\
    tag:'attack-deserialization',\
    tag:'polaris-custom-rules'"

